name: test
on: [ push, pull_request ]
env:
  CURL: "curl -fsSkL --retry 9 --retry-delay 9"
  GHRAW: "https://raw.githubusercontent.com"
jobs:
  test:
    runs-on: ubuntu-20.04
    strategy:
      matrix:
        emacs_version:
        # - 25.1
        # # 25.2 is identical to 25.3 except for a critical security bug in
        # # enriched text mode (see Emacs Bug#28350).
        # - 25.3
        # - 26.1   # Debian is on this version.
        # - 26.3
        # - 27.1
        - snapshot
    steps:
    - uses: cachix/install-nix-action@v12
    - uses: actions/checkout@v2
    - name: Install
      run: |
        # Enable cachix 
        nix-env -iA cachix -f https://cachix.org/api/v1/install
        cachix use emacs-ci

        nix-env -f ./t/default.nix -iA emacs-${{ matrix.emacs_version }}

        emacs --version
        git config --global user.name "A U Thor"
        git config --global user.email a.u.thor@example.com
        git tag 0
    - name: Compile
      run: |
        make lisp DASH_DIR=$PWD
    - name: Test
      run: |
        make test-in-ci DASH_DIR=$PWD
